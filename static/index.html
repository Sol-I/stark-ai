<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stark AI</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f0f0f0;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .chat-section, .logs-section {
            display: flex;
            flex-direction: column;
        }
        .chat-container {
            height: 400px;
            border: 1px solid #ddd;
            padding: 10px;
            margin-bottom: 10px;
            background: #fafafa;
            border-radius: 5px;
            overflow-y: auto;
        }
        .logs-container {
            height: 400px;
            border: 1px solid #ddd;
            padding: 10px;
            background: #1e1e1e;
            color: #00ff00;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            border-radius: 5px;
            overflow-y: auto;
        }
        .message {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
        }
        .user {
            background: #007bff;
            color: white;
            text-align: right;
        }
        .bot {
            background: #e9ecef;
            color: #333;
        }
        .log-entry {
            margin: 2px 0;
            padding: 2px 5px;
            border-radius: 3px;
        }
        .log-info { background: #2d3748; }
        .log-warning { background: #744210; color: #faf089; }
        .log-error { background: #742a2a; color: #fc8181; }
        .log-debug { background: #2a4365; color: #90cdf4; }
        .input-container {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        button {
            padding: 10px 20px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        button:hover {
            background: #0056b3;
        }
        h1, h2 {
            margin-top: 0;
        }
        .status-bar {
            grid-column: 1 / -1;
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="status-bar">
            <strong>ü§ñ Stark AI Agent</strong> |
            <span id="status">–ó–∞–≥—Ä—É–∑–∫–∞...</span> |
            <span id="modelInfo">–ú–æ–¥–µ–ª—å: -</span> |
            <button onclick="refreshLogs()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å –ª–æ–≥–∏</button>
            <button onclick="clearLogs()">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å —á–∞—Ç</button>
        </div>

        <div class="chat-section">
            <h2>üí¨ –ß–∞—Ç —Å AI</h2>
            <div class="chat-container" id="chat"></div>
            <div class="input-container">
                <input type="text" id="message" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." autocomplete="off">
                <button onclick="sendMessage()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
            </div>
        </div>

        <div class="logs-section">
            <h2>üìä –õ–æ–≥–∏ —Å–∏—Å—Ç–µ–º—ã</h2>
            <div class="logs-container" id="logs"></div>
        </div>
    </div>

    <script>
        const chat = document.getElementById('chat');
        const logs = document.getElementById('logs');
        const messageInput = document.getElementById('message');
        const status = document.getElementById('status');
        const modelInfo = document.getElementById('modelInfo');
        const userId = 'web_user_' + Math.random().toString(36).substr(2, 9);

        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —á–∞—Ç–∞
        function addMessage(text, isUser = false) {
            const msg = document.createElement('div');
            msg.className = `message ${isUser ? 'user' : 'bot'}`;
            msg.textContent = text;
            chat.appendChild(msg);
            chat.scrollTop = chat.scrollHeight;
        }

        async function sendMessage() {
            const message = messageInput.value.trim();
            if (!message) return;

            addMessage(message, true);
            messageInput.value = '';
            status.textContent = '–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞...';

            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: userId, message: message })
                });

                const data = await response.json();
                addMessage(data.response);
                status.textContent = '–ì–æ—Ç–æ–≤';

                // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –º–æ–¥–µ–ª–∏ –∏–∑ –æ—Ç–≤–µ—Ç–∞
                if (data.response.includes('–û—Ç–≤–µ—á–∞–µ—Ç')) {
                    const modelMatch = data.response.match(/–û—Ç–≤–µ—á–∞–µ—Ç (.+?) \(/);
                    if (modelMatch) {
                        modelInfo.textContent = `–ú–æ–¥–µ–ª—å: ${modelMatch[1]}`;
                    }
                }

            } catch (error) {
                addMessage('‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è');
                status.textContent = '–û—à–∏–±–∫–∞';
            }

            refreshLogs();
        }

        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –ª–æ–≥–æ–≤
        function addLogEntry(log) {
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${log.level.toLowerCase()}`;
            logEntry.innerHTML = `
                <span style="color: #888">[${log.timestamp}]</span>
                <strong>${log.level}</strong>
                <span style="color: #ccc">${log.user_id}:</span>
                ${log.message}
            `;
            logs.appendChild(logEntry);
            logs.scrollTop = logs.scrollHeight;
        }

        async function refreshLogs() {
            try {
                const response = await fetch('/api/logs');
                const data = await response.json();

                logs.innerHTML = '';
                data.logs.slice(-50).forEach(log => addLogEntry(log));

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ª–æ–≥–æ–≤:', error);
            }
        }

        async function clearLogs() {
            try {
                await fetch('/api/clear', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: userId })
                });
                chat.innerHTML = '';
                addMessage('–ò—Å—Ç–æ—Ä–∏—è —á–∞—Ç–∞ –æ—á–∏—â–µ–Ω–∞');
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏:', error);
            }
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });

        // –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ª–æ–≥–æ–≤ –∫–∞–∂–¥—ã–µ 3 —Å–µ–∫—É–Ω–¥—ã
        setInterval(refreshLogs, 3000);

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        messageInput.focus();
        addMessage('–ü—Ä–∏–≤–µ—Ç! –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?');
        refreshLogs();
        status.textContent = '–ì–æ—Ç–æ–≤';
    </script>
</body>
</html>